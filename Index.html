<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Molecule Mix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Infant:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cormorant Infant', serif;
        }
        .bg-gradient {
            background-image: linear-gradient(135deg, #1f2937 0%, #0d121c 100%);
        }
        .card {
            background-color: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
        }
        .btn-element {
            transition: all 0.2s ease-in-out;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-element:hover {
            transform: translateY(-2px) scale(1.05);
            background-color: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .btn-action {
            background-color: #3b82f6;
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        .btn-action:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
        }
        .btn-danger {
            background-color: #ef4444;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .btn-success {
            background-color: #22c55e;
        }
        .btn-success:hover {
            background-color: #16a34a;
        }
        .btn-lifeline {
            background-color: #f59e0b;
            transition: all 0.2s ease-in-out;
        }
        .btn-lifeline:hover {
            background-color: #d97706;
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85);
            border-radius: 12px;
            padding: 3rem 2rem;
            color: white;
            z-index: 100;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            width: 90%;
            max-width: 500px;
        }
        .message-box p {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }
        .pulse-green {
            animation: pulse-green 0.5s ease-in-out;
        }
        .pulse-red {
            animation: pulse-red 0.5s ease-in-out;
        }
        @keyframes pulse-green {
            0% { transform: scale(1); background-color: #22c55e; }
            50% { transform: scale(1.05); background-color: #16a34a; }
            100% { transform: scale(1); background-color: #22c55e; }
        }
        @keyframes pulse-red {
            0% { transform: scale(1); background-color: #ef4444; }
            50% { transform: scale(1.05); background-color: #dc2626; }
            100% { transform: scale(1); background-color: #ef4444; }
        }
        /* Molecule element styling */
        .molecule-atom {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 0.5rem;
            cursor: move;
            transition: transform 0.2s ease-in-out;
        }
        .molecule-atom-controls {
            display: flex;
            flex-direction: column;
            position: absolute;
            right: -10px;
            top: -10px;
            gap: 2px;
        }
        .atom-control-btn {
            background: #4b5563;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            line-height: 1;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">
    <div class="container mx-auto p-4 md:p-8 rounded-2xl shadow-2xl card flex flex-col items-center">
        <h1 class="text-4xl md:text-5xl font-bold text-center mb-6 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-600">Molecule Mix</h1>
        <div class="w-full flex justify-between items-center mb-4">
            <div class="flex items-center gap-2">
                <span class="text-gray-400">Score:</span>
                <span id="molecules-built" class="text-xl font-bold">0</span>
            </div>
            <div class="flex items-center gap-2">
                <label for="difficulty" class="text-gray-400">Difficulty:</label>
                <select id="difficulty" class="bg-gray-700 text-white rounded-md p-1 outline-none">
                    <option value="easy">Easy</option>
                    <option value="medium">Medium</option>
                    <option value="hard">Hard</option>
                </select>
            </div>
        </div>

        <div class="w-full grid md:grid-cols-2 gap-8 mb-8">
            <!-- Game Section -->
            <div class="card p-6 rounded-2xl">
                <h2 class="text-3xl font-bold mb-4 text-center">Build This Molecule</h2>
                <div class="flex flex-col items-center justify-center bg-gray-800 p-6 rounded-xl shadow-inner mb-4">
                    <h3 id="target-title" class="text-2xl font-semibold text-blue-300"></h3>
                    <p id="target-formula" class="text-5xl font-bold my-2"></p>
                    <p id="target-description" class="text-sm text-gray-400 text-center"></p>
                    <div id="starting-elements-display" class="mt-4 p-2 bg-gray-900 rounded-lg hidden"></div>
                </div>

                <div class="w-full flex justify-center mb-4">
                    <div id="how-it-works" class="text-sm text-center text-gray-400"></div>
                </div>

                <div class="flex justify-between items-center text-xl font-bold mb-4">
                    <span>Your Molecule</span>
                    <span class="text-sm text-gray-400" id="molar-mass-label">Molar Mass: <span id="molar-mass">0.00</span></span>
                </div>

                <div id="current-molecule-container" class="card p-4 rounded-xl mb-4 h-40 flex items-center justify-center">
                    <div id="current-molecule" class="w-full h-full flex items-center justify-center gap-4 flex-wrap">
                        <p class="text-gray-500">Drag elements here to begin...</p>
                    </div>
                </div>
                
                <div class="flex flex-col md:flex-row gap-4 mb-4">
                    <button id="check-btn" class="flex-1 btn-action text-white font-bold py-3 px-6 rounded-full shadow-lg">Check Formula</button>
                    <button id="next-btn" class="flex-1 btn-action text-white font-bold py-3 px-6 rounded-full shadow-lg hidden">Next Molecule</button>
                    <button id="clear-btn" class="flex-1 btn-danger text-white font-bold py-3 px-6 rounded-full shadow-lg">Clear</button>
                </div>
                
                <div id="game-message" class="text-center font-semibold mt-2"></div>
            </div>

            <!-- Elements and Leaderboard Section -->
            <div class="flex flex-col gap-8">
                <div class="card p-6 rounded-2xl flex-1">
                    <h2 class="text-2xl font-bold mb-4 text-center">Periodic Table</h2>
                    <div id="element-grid" class="grid grid-cols-4 md:grid-cols-5 gap-3"></div>
                </div>
                
                <div id="lifelines-section" class="card p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4 text-center">Lifelines</h2>
                    <div class="flex flex-col gap-2">
                        <button id="show-molar-mass-btn" class="btn-lifeline text-white font-bold py-2 px-4 rounded-full shadow-md"></button>
                        <button id="add-atom-btn" class="btn-lifeline text-white font-bold py-2 px-4 rounded-full shadow-md"></button>
                        <button id="swap-atom-btn" class="btn-lifeline text-white font-bold py-2 px-4 rounded-full shadow-md"></button>
                        <button id="hint-btn" class="btn-lifeline text-white font-bold py-2 px-4 rounded-full shadow-md"></button>
                    </div>
                </div>
                
                <div class="card p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4 text-center">Leaderboard</h2>
                    <p class="text-sm text-gray-400 text-center mb-2">Your High Score: <span id="personal-high-score" class="font-bold">0</span></p>
                    <ol id="leaderboard-list" class="flex flex-col gap-2"></ol>
                    <div class="mt-4 text-center text-sm text-gray-500">
                      Your User ID: <span class="font-mono" id="user-id">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Message Box -->
        <div id="message-box" class="message-box hidden">
            <p id="message-text"></p>
            <button id="message-btn" class="w-full btn-action text-white font-bold py-2 px-4 rounded-full">Got it!</button>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firebase global variables. DO NOT CHANGE
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db = null;
        let auth = null;
        let userId = null;
        
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase initialized");
        } catch (e) {
            console.error("Firebase initialization failed:", e);
        }

        async function initAuth() {
            if (!auth) {
                console.error("Auth not initialized.");
                return;
            }
            onAuthStateChanged(auth, async (user) => {
                const userIdEl = document.getElementById('user-id');
                if (user) {
                    userId = user.uid;
                    if(userIdEl) userIdEl.textContent = userId;
                    console.log("User signed in with UID:", userId);
                    await initializePlayerScore();
                    setupLeaderboardListener();
                } else {
                    console.log("No user signed in. Attempting anonymous sign-in...");
                    try {
                        if (initialAuthToken) {
                             await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Auth error:", error);
                    }
                }
            });
        }
        
        async function initializePlayerScore() {
            if (!db || !userId) return;
            try {
                const userRef = doc(db, 'artifacts', appId, 'users', userId, 'userData', 'scores');
                const userDoc = await getDoc(userRef);
                const scoreEl = document.getElementById('personal-high-score');
                let userScore = 0;
                if (!userDoc.exists()) {
                    await setDoc(userRef, { score: 0 });
                    console.log("Initialized new player score.");
                } else {
                    userScore = userDoc.data().score;
                    console.log("Player score already exists.");
                }
                if (scoreEl) scoreEl.textContent = userScore;
            } catch (e) {
                console.error("Error initializing player score:", e);
            }
        }
        
        async function updateHighScore(newScore) {
            if (!db || !userId) {
                console.error("Firestore or user ID not available.");
                return;
            }
            try {
                const userRef = doc(db, 'artifacts', appId, 'users', userId, 'userData', 'scores');
                const publicScoreRef = doc(db, 'artifacts', appId, 'public', 'data', 'top_scores', userId);

                const userDoc = await getDoc(userRef);
                const currentScore = userDoc.exists() ? userDoc.data().score : 0;

                if (newScore > currentScore) {
                    await setDoc(userRef, { score: newScore }, { merge: true });
                    await setDoc(publicScoreRef, { userId: userId, score: newScore }, { merge: true });
                    console.log(`High score updated to ${newScore}`);
                    document.getElementById('personal-high-score').textContent = newScore;
                }
            } catch (e) {
                console.error("Error updating high score:", e);
            }
        }

        function setupLeaderboardListener() {
            if (!db) return;
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'top_scores'), orderBy('score', 'desc'), limit(10));
            onSnapshot(q, (snapshot) => {
                const leaderboard = [];
                snapshot.forEach(doc => {
                    leaderboard.push(doc.data());
                });
                renderLeaderboard(leaderboard);
            }, (error) => {
                console.error("Leaderboard listener failed:", error);
            });
        }
        
        function renderLeaderboard(scores) {
            const leaderboardList = document.getElementById('leaderboard-list');
            if (!leaderboardList) return;
            leaderboardList.innerHTML = '';
            scores.forEach((score, index) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-gray-700 p-2 rounded-lg';
                li.innerHTML = `
                    <span class="text-blue-300 font-bold">${index + 1}.</span>
                    <span class="text-gray-400 font-mono text-sm">${score.userId}</span>
                    <span class="text-white">${score.score}</span>
                `;
                leaderboardList.appendChild(li);
            });
        }
        
        // --- Game Logic ---
        window.onload = function() {
            const elementsData = [
                { symbol: 'H', name: 'Hydrogen', mass: 1.01 },
                { symbol: 'O', name: 'Oxygen', mass: 16.00 },
                { symbol: 'C', name: 'Carbon', mass: 12.01 },
                { symbol: 'N', name: 'Nitrogen', mass: 14.01 },
                { symbol: 'Cl', name: 'Chlorine', mass: 35.45 },
                { symbol: 'Na', name: 'Sodium', mass: 22.99 },
                { symbol: 'S', name: 'Sulfur', mass: 32.07 },
                { symbol: 'P', name: 'Phosphorus', mass: 30.97 },
                { symbol: 'Mg', name: 'Magnesium', mass: 24.31 },
                { symbol: 'K', name: 'Potassium', mass: 39.10 },
                { symbol: 'Fe', name: 'Iron', mass: 55.85 },
                { symbol: 'Ca', name: 'Calcium', mass: 40.08 },
                { symbol: 'Al', name: 'Aluminum', mass: 26.98 },
                { symbol: 'Si', name: 'Silicon', mass: 28.09 },
                { symbol: 'F', name: 'Fluorine', mass: 19.00 },
                { symbol: 'Br', name: 'Bromine', mass: 79.90 },
                { symbol: 'He', name: 'Helium', mass: 4.00 },
                { symbol: 'Li', name: 'Lithium', mass: 6.94 },
                { symbol: 'Ne', name: 'Neon', mass: 20.18 },
                { symbol: 'Ar', name: 'Argon', mass: 39.95 },
                { symbol: 'U', name: 'Uranium', mass: 238.03 },
            ];

            const moleculesData = {
                easy: [
                    { name: 'Water', formula: 'H₂O', atoms: { 'H': 2, 'O': 1 }, description: 'The most abundant molecule on Earth, essential for life.' },
                    { name: 'Carbon Dioxide', formula: 'CO₂', atoms: { 'C': 1, 'O': 2 }, description: 'A greenhouse gas used by plants for photosynthesis.' },
                    { name: 'Methane', formula: 'CH₄', atoms: { 'C': 1, 'H': 4 }, description: 'The primary component of natural gas.' },
                    { name: 'Ammonia', formula: 'NH₃', atoms: { 'N': 1, 'H': 3 }, description: 'A common cleaning agent with a distinctive, sharp smell.' },
                    { name: 'Hydrochloric Acid', formula: 'HCl', atoms: { 'H': 1, 'Cl': 1 }, description: 'A strong acid found in stomach fluids to aid digestion.' },
                    { name: 'Hydrogen Peroxide', formula: 'H₂O₂', atoms: { 'H': 2, 'O': 2 }, description: 'Commonly used as a mild antiseptic for minor cuts.' },
                    { name: 'Sodium Hydroxide', formula: 'NaOH', atoms: { 'Na': 1, 'O': 1, 'H': 1 }, description: 'Commonly known as lye, a strong base.' },
                    { name: 'Sulfur Dioxide', formula: 'SO₂', atoms: { 'S': 1, 'O': 2 }, description: 'A gas released from volcanoes and industrial processes.' },
                    { name: 'Salt (LiCl)', formula: 'LiCl', atoms: { 'Li': 1, 'Cl': 1 }, description: 'Lithium Chloride, a salt with a bitter taste.' },
                    { name: 'Propene', formula: 'C₃H₆', atoms: { 'C': 3, 'H': 6 }, description: 'An unsaturated hydrocarbon.' },
                ],
                medium: [
                    { name: 'Sodium Chloride', formula: 'NaCl', atoms: { 'Na': 1, 'Cl': 1 }, description: 'Common table salt, an ionic compound.' },
                    { name: 'Sulfuric Acid', formula: 'H₂SO₄', atoms: { 'H': 2, 'S': 1, 'O': 4 }, description: 'A highly corrosive acid used in industrial applications.' },
                    { name: 'Baking Soda', formula: 'NaHCO₃', atoms: { 'Na': 1, 'H': 1, 'C': 1, 'O': 3 }, description: 'A leavening agent used in baking to make dough rise.' },
                    { name: 'Glucose', formula: 'C₆H₁₂O₆', atoms: { 'C': 6, 'H': 12, 'O': 6 }, description: 'A simple sugar that is a key source of energy for living organisms.' },
                    { name: 'Ethane', formula: 'C₂H₆', atoms: { 'C': 2, 'H': 6 }, description: 'The second simplest alkane hydrocarbon, found in natural gas.' },
                    { name: 'Urea', formula: 'CH₄N₂O', atoms: { 'C': 1, 'H': 4, 'N': 2, 'O': 1 }, description: 'Used in fertilizers, and produced by the body to excrete nitrogen.' },
                    { name: 'Propane', formula: 'C₃H₈', atoms: { 'C': 3, 'H': 8 }, description: 'A common fuel for stoves, heating, and vehicles.' },
                    { name: 'Magnesium Hydroxide', formula: 'Mg(OH)₂', atoms: { 'Mg': 1, 'O': 2, 'H': 2 }, description: 'Known as milk of magnesia, a common antacid.' },
                    { name: 'Phosphoric Acid', formula: 'H₃PO₄', atoms: { 'H': 3, 'P': 1, 'O': 4 }, description: 'Used in sodas and fertilizers.' },
                    { name: 'Potassium Nitrate', formula: 'KNO₃', atoms: { 'K': 1, 'N': 1, 'O': 3 }, description: 'A key component of gunpowder and fertilizers.' },
                    { name: 'Calcium Carbonate', formula: 'CaCO₃', atoms: { 'Ca': 1, 'C': 1, 'O': 3 }, description: 'The main component of shells, limestone, and chalk.' }
                ],
                hard: [
                    { name: 'Water', formula: 'H₂O', targetAtoms: { 'H': 2, 'O': 1 }, moles: 2, startingAtoms: { 'H': 5, 'O': 3 }, description: 'Build two moles of water. What elements will be left over?' },
                    { name: 'Carbon Dioxide', formula: 'CO₂', targetAtoms: { 'C': 1, 'O': 2 }, moles: 3, startingAtoms: { 'C': 4, 'O': 7 }, description: 'Build three moles of Carbon Dioxide. Be careful with your counts!' },
                    { name: 'Sucrose', formula: 'C₁₂H₂₂O₁₁', targetAtoms: { 'C': 12, 'H': 22, 'O': 11 }, moles: 1, startingAtoms: { 'C': 15, 'H': 25, 'O': 12 }, description: 'Build one molecule of table sugar from the given atoms. You will have leftovers.' },
                    { name: 'Ethanol', formula: 'C₂H₆O', targetAtoms: { 'C': 2, 'H': 6, 'O': 1 }, moles: 2, startingAtoms: { 'C': 5, 'H': 15, 'O': 3 }, description: 'Build two moles of ethanol. You must use the correct quantity of each starting element.' },
                    { name: 'Aluminum Sulfate', formula: 'Al₂(SO₄)₃', targetAtoms: { 'Al': 2, 'S': 3, 'O': 12 }, moles: 1, startingAtoms: { 'Al': 3, 'S': 4, 'O': 15 }, description: 'Make this industrial chemical. This is a tough one!' },
                    { name: 'Ammonium Nitrate', formula: 'NH₄NO₃', targetAtoms: { 'N': 2, 'H': 4, 'O': 3 }, moles: 1, startingAtoms: { 'N': 4, 'H': 6, 'O': 5 }, description: 'This is a key component in fertilizer and explosives. Be precise.' },
                    { name: 'Ferric Oxide (Rust)', formula: 'Fe₂O₃', targetAtoms: { 'Fe': 2, 'O': 3 }, moles: 2, startingAtoms: { 'Fe': 5, 'O': 7 }, description: 'Build two moles of rust from the starting atoms.' },
                    { name: 'Magnesium Nitrate', formula: 'Mg(NO₃)₂', targetAtoms: { 'Mg': 1, 'N': 2, 'O': 6 }, moles: 1, startingAtoms: { 'Mg': 2, 'N': 3, 'O': 8 }, description: 'This compound is used in agriculture and pyrotechnics.' },
                    { name: 'Boric Acid', formula: 'H₃BO₃', targetAtoms: { 'H': 3, 'B': 1, 'O': 3 }, moles: 2, startingAtoms: { 'H': 7, 'B': 3, 'O': 7 }, description: 'Used as an antiseptic and insecticide.' }
                ]
            };

            // DOM elements
            const difficultySelect = document.getElementById('difficulty');
            const moleculesBuiltEl = document.getElementById('molecules-built');
            const targetTitleEl = document.getElementById('target-title');
            const targetFormulaEl = document.getElementById('target-formula');
            const targetDescriptionEl = document.getElementById('target-description');
            const howItWorksEl = document.getElementById('how-it-works');
            const currentMoleculeEl = document.getElementById('current-molecule');
            const molarMassEl = document.getElementById('molar-mass');
            const elementGrid = document.getElementById('element-grid');
            const checkBtn = document.getElementById('check-btn');
            const nextBtn = document.getElementById('next-btn');
            const clearBtn = document.getElementById('clear-btn');
            const gameMessageEl = document.getElementById('game-message');
            const showMolarMassBtn = document.getElementById('show-molar-mass-btn');
            const addAtomBtn = document.getElementById('add-atom-btn');
            const swapAtomBtn = document.getElementById('swap-atom-btn');
            const hintBtn = document.getElementById('hint-btn');
            const startingElementsEl = document.getElementById('starting-elements-display');

            // Game state
            let moleculesBuilt = 0;
            let currentLevel = 'easy';
            let levelMolecules = [];
            let currentTarget = null;
            let currentElements = {};
            let currentMolarMass = 0;
            let lifelines = {
                showMass: 1,
                addAtom: 1,
                swapAtom: 1,
                hint: 1
            };

            // Message box
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            const messageBtn = document.getElementById('message-btn');
            
            // Helper function for showing messages
            function showMessage(text) {
                messageText.innerHTML = text;
                messageBox.classList.remove('hidden');
            }

            // Helper function to hide the message box
            function hideMessage() {
                messageBox.classList.add('hidden');
            }

            // Function to calculate the molar mass of a molecule
            function calculateMolarMass(atoms) {
                let totalMass = 0;
                for (const symbol in atoms) {
                    const element = elementsData.find(e => e.symbol === symbol);
                    if (element) {
                        totalMass += element.mass * atoms[symbol];
                    }
                }
                return totalMass;
            }

            // Function to render elements on the screen
            function renderElements() {
                elementGrid.innerHTML = '';
                elementsData.forEach(element => {
                    const btn = document.createElement('div');
                    btn.className = 'btn-element flex flex-col items-center justify-center p-4 rounded-xl shadow-md cursor-pointer transition-colors duration-200 hover:bg-white/20';
                    btn.draggable = true;
                    btn.dataset.symbol = element.symbol;
                    btn.innerHTML = `
                        <span class="text-4xl font-bold text-blue-300">${element.symbol}</span>
                        <span class="text-xs text-gray-400 font-mono">${element.mass.toFixed(2)} g/mol</span>
                    `;
                    btn.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', element.symbol);
                    });
                    elementGrid.appendChild(btn);
                });
            }
            
            // Function to start or restart the game
            function startGame() {
                moleculesBuilt = 0;
                moleculesBuiltEl.textContent = moleculesBuilt;
                currentLevel = difficultySelect.value;
                levelMolecules = [...moleculesData[currentLevel]];
                lifelines = { showMass: 1, addAtom: 1, swapAtom: 1, hint: 1 };
                updateLifelinesUI();
                nextMolecule();
            }

            // Function to move to the next molecule
            function nextMolecule() {
                if (levelMolecules.length === 0) {
                    showMessage('Congratulations! You completed all the molecules for this difficulty level. Your score has been saved!');
                    updateHighScore(moleculesBuilt);
                    startGame(); // Restart the level
                    return;
                }
                const randomIndex = Math.floor(Math.random() * levelMolecules.length);
                currentTarget = levelMolecules.splice(randomIndex, 1)[0];
                updateGameUI();
                resetGame();
                checkBtn.classList.remove('hidden');
                nextBtn.classList.add('hidden');
            }

            // Function to update the UI based on the current target molecule
            function updateGameUI() {
                if (currentTarget.moles > 1) {
                    targetTitleEl.textContent = `${currentTarget.moles} moles of ${currentTarget.name}`;
                } else {
                    targetTitleEl.textContent = currentTarget.name;
                }
                let formulaHtml = currentTarget.formula.replace(/(\d+)/g, '<sub>$1</sub>');
                targetFormulaEl.innerHTML = formulaHtml;
                targetDescriptionEl.textContent = currentTarget.description;
                
                // Show starting elements for hard mode
                if (currentLevel === 'hard') {
                    startingElementsEl.classList.remove('hidden');
                    let startingHtml = '';
                    for (const [symbol, count] of Object.entries(currentTarget.startingAtoms)) {
                        startingHtml += `<div class="bg-gray-700 text-white rounded-lg px-2 py-1">${symbol}<sub>${count}</sub></div>`;
                    }
                    startingElementsEl.innerHTML = `<p class="text-xs text-gray-400">Starting Elements:</p> <div class="flex gap-2 mt-1">${startingHtml}</div>`;
                    howItWorksEl.innerHTML = `Your goal is to use the **starting elements** below to build the molecule. You must use the **exact** quantities of atoms required!`;
                } else {
                    startingElementsEl.classList.add('hidden');
                    howItWorksEl.innerHTML = `Your goal is to match the correct **molar ratio** of elements to build the molecule. Drag elements below and drop them in the box!`;
                }
            }

            // Function to add an element to the current molecule
            function addElement(symbol) {
                currentElements[symbol] = (currentElements[symbol] || 0) + 1;
                const element = elementsData.find(e => e.symbol === symbol);
                currentMolarMass += element.mass;
                renderCurrentMolecule();
            }

            // Function to render the selected elements in the UI
            function renderCurrentMolecule() {
                currentMoleculeEl.innerHTML = '';
                if (Object.keys(currentElements).length === 0) {
                    currentMoleculeEl.innerHTML = '<p class="text-gray-500">Drag elements here to begin...</p>';
                } else {
                    for (const symbol in currentElements) {
                        const count = currentElements[symbol];
                        const element = elementsData.find(e => e.symbol === symbol);

                        const elementEl = document.createElement('div');
                        elementEl.className = 'molecule-atom flex flex-col items-center justify-center';
                        elementEl.innerHTML = `
                            <span class="text-3xl font-bold text-blue-300">${symbol}</span>
                            <span class="text-sm bg-gray-600 px-1 rounded absolute bottom-0 right-0">${count}</span>
                            <div class="molecule-atom-controls">
                                <button class="atom-control-btn" data-action="add" data-symbol="${symbol}">+</button>
                                <button class="atom-control-btn" data-action="subtract" data-symbol="${symbol}">-</button>
                                <button class="atom-control-btn" data-action="delete" data-symbol="${symbol}">&times;</button>
                            </div>
                        `;
                        currentMoleculeEl.appendChild(elementEl);
                    }
                }
                molarMassEl.textContent = currentMolarMass.toFixed(2);
            }

            // Function to reset the game state
            function resetGame() {
                currentElements = {};
                currentMolarMass = 0;
                gameMessageEl.innerHTML = '';
                renderCurrentMolecule();
            }

            // Function to update lifeline UI
            function updateLifelinesUI() {
                showMolarMassBtn.textContent = `Show Molar Mass (${lifelines.showMass})`;
                addAtomBtn.textContent = `Auto-Add Atom (${lifelines.addAtom})`;
                swapAtomBtn.textContent = `Swap Atom (${lifelines.swapAtom})`;
                hintBtn.textContent = `Hint (${lifelines.hint})`;

                showMolarMassBtn.disabled = lifelines.showMass <= 0;
                addAtomBtn.disabled = lifelines.addAtom <= 0;
                swapAtomBtn.disabled = lifelines.swapAtom <= 0;
                hintBtn.disabled = lifelines.hint <= 0;
            }

            // Event listener for the "Check Formula" button
            checkBtn.addEventListener('click', () => {
                const targetAtoms = currentTarget.targetAtoms || currentTarget.atoms;
                const totalTargetAtoms = {};
                for (const [symbol, count] of Object.entries(targetAtoms)) {
                    totalTargetAtoms[symbol] = count * (currentTarget.moles || 1);
                }

                // Check if element ratios and counts match
                const currentRatio = Object.keys(currentElements).map(key => ({ symbol: key, count: currentElements[key] })).sort((a, b) => a.symbol.localeCompare(b.symbol));
                const targetRatio = Object.keys(totalTargetAtoms).map(key => ({ symbol: key, count: totalTargetAtoms[key] })).sort((a, b) => a.symbol.localeCompare(b.symbol));

                let isRatioMatch = false;
                if (currentRatio.length === targetRatio.length) {
                isRatioMatch = currentRatio.every((val, index) => {
                    return val.symbol === targetRatio[index].symbol && val.count === targetRatio[index].count;
                });
                }

                const singleMoleMass = calculateMolarMass(targetAtoms);
                const totalTargetMass = singleMoleMass * (currentTarget.moles || 1);
                const massMatch = Math.abs(currentMolarMass - totalTargetMass) < 0.02;

                if (currentLevel === 'hard') {
                    const startingAtoms = currentTarget.startingAtoms;
                    let isCountValid = true;
                    for (const symbol in currentElements) {
                        if ((startingAtoms[symbol] || 0) < currentElements[symbol]) {
                            isCountValid = false;
                            break;
                        }
                    }
                    if (isRatioMatch && isCountValid) {
                        gameMessageEl.innerHTML = `<span class="text-green-400">Correct!</span><br/>`;
                        let leftover = {};
                        for (const symbol in startingAtoms) {
                            const usedCount = currentElements[symbol] || 0;
                            leftover[symbol] = startingAtoms[symbol] - usedCount;
                        }
                        let leftoverText = "Leftover atoms:";
                        for (const [symbol, count] of Object.entries(leftover)) {
                            if (count > 0) {
                                leftoverText += ` ${symbol}<sub>${count}</sub>`;
                            }
                        }
                        gameMessageEl.innerHTML += `<span class="text-white">${leftoverText}</span>`;
                        moleculesBuilt++;
                        moleculesBuiltEl.textContent = moleculesBuilt;
                        checkBtn.classList.add('btn-success');
                        checkBtn.classList.add('pulse-green');
                        checkBtn.classList.add('hidden');
                        nextBtn.classList.remove('hidden');
                    } else {
                        gameMessageEl.innerHTML = `<span class="text-red-400">Incorrect. Check your atom counts and ratios.</span>`;
                        checkBtn.classList.add('btn-danger');
                        checkBtn.classList.add('pulse-red');
                        setTimeout(() => checkBtn.classList.remove('btn-danger', 'pulse-red'), 1000);
                    }
                } else {
                    if (massMatch && isRatioMatch) {
                        gameMessageEl.innerHTML = `<span class="text-green-400">Correct! You formed ${currentTarget.moles || 1} mole(s) of ${currentTarget.name}.</span>`;
                        moleculesBuilt++;
                        moleculesBuiltEl.textContent = moleculesBuilt;
                        checkBtn.classList.add('btn-success');
                        checkBtn.classList.add('pulse-green');
                        checkBtn.classList.add('hidden');
                        nextBtn.classList.remove('hidden');
                    } else {
                        gameMessageEl.innerHTML = `<span class="text-red-400">Incorrect formula. The total molar mass or element ratios are wrong. Try again!</span>`;
                        checkBtn.classList.add('btn-danger');
                        checkBtn.classList.add('pulse-red');
                        setTimeout(() => checkBtn.classList.remove('btn-danger', 'pulse-red'), 1000);
                    }
                }
            });

            // Event listener for the "Next Molecule" button
            nextBtn.addEventListener('click', () => {
                checkBtn.classList.remove('btn-success', 'pulse-green');
                nextMolecule();
            });

            // Event listener for the "Clear" button
            clearBtn.addEventListener('click', resetGame);

            // Event listeners for Lifelines
            showMolarMassBtn.addEventListener('click', () => {
                if (lifelines.showMass > 0) {
                    const targetAtoms = currentTarget.targetAtoms || currentTarget.atoms;
                    const singleMoleMass = calculateMolarMass(targetAtoms);
                    const totalTargetMass = singleMoleMass * (currentTarget.moles || 1);
                    showMessage(`The target molar mass is **${totalTargetMass.toFixed(2)}** g/mol.`);
                    lifelines.showMass--;
                    updateLifelinesUI();
                }
            });

            addAtomBtn.addEventListener('click', () => {
                if (lifelines.addAtom > 0) {
                    const targetAtoms = currentTarget.targetAtoms || currentTarget.atoms;
                    const totalTargetAtoms = {};
                    for (const [symbol, count] of Object.entries(targetAtoms)) {
                        totalTargetAtoms[symbol] = count * (currentTarget.moles || 1);
                    }
                    const missingSymbols = Object.keys(totalTargetAtoms).filter(symbol => (currentElements[symbol] || 0) < totalTargetAtoms[symbol]);
                    if (missingSymbols.length > 0) {
                        const randomSymbol = missingSymbols[Math.floor(Math.random() * missingSymbols.length)];
                        addElement(randomSymbol);
                        showMessage(`I've added one **${randomSymbol}** for you!`);
                        lifelines.addAtom--;
                        updateLifelinesUI();
                    } else {
                        showMessage("You've already added all the required atoms!");
                    }
                }
            });
            
            swapAtomBtn.addEventListener('click', () => {
                if (lifelines.swapAtom > 0) {
                    const incorrectSymbols = Object.keys(currentElements).filter(symbol => {
                        const targetAtoms = currentTarget.targetAtoms || currentTarget.atoms;
                        const totalTargetAtoms = {};
                        for (const [targetSymbol, count] of Object.entries(targetAtoms)) {
                            totalTargetAtoms[targetSymbol] = count * (currentTarget.moles || 1);
                        }
                        return !totalTargetAtoms[symbol] || currentElements[symbol] > totalTargetAtoms[symbol];
                    });

                    if (incorrectSymbols.length > 0) {
                        const symbolToSwap = incorrectSymbols[0];
                        
                        // Find a correct atom that is needed and is not in the current molecule or has less than the required amount
                        const targetAtoms = currentTarget.targetAtoms || currentTarget.atoms;
                        const totalTargetAtoms = {};
                        for (const [targetSymbol, count] of Object.entries(targetAtoms)) {
                            totalTargetAtoms[targetSymbol] = count * (currentTarget.moles || 1);
                        }
                        const missingSymbols = Object.keys(totalTargetAtoms).filter(symbol => (currentElements[symbol] || 0) < totalTargetAtoms[symbol]);
                        
                        if (missingSymbols.length > 0) {
                            const symbolToAdd = missingSymbols[0];
                            
                            // Subtract the incorrect element
                            currentElements[symbolToSwap]--;
                            if (currentElements[symbolToSwap] === 0) {
                                delete currentElements[symbolToSwap];
                            }
                            // Add the correct element
                            addElement(symbolToAdd);

                            showMessage(`Swapped one **${symbolToSwap}** for one **${symbolToAdd}**!`);
                            lifelines.swapAtom--;
                            updateLifelinesUI();
                        } else {
                            showMessage("No incorrect or extra atoms to swap!");
                        }
                    } else {
                        showMessage("No incorrect or extra atoms to swap!");
                    }
                }
            });

            hintBtn.addEventListener('click', () => {
                if (lifelines.hint > 0) {
                    const hintText = currentTarget.description;
                    showMessage(`Hint: ${hintText}`);
                    lifelines.hint--;
                    updateLifelinesUI();
                }
            });

            // Drag and Drop Logic
            currentMoleculeEl.addEventListener('dragover', (e) => {
                e.preventDefault();
            });
            currentMoleculeEl.addEventListener('drop', (e) => {
                e.preventDefault();
                const symbol = e.dataTransfer.getData('text/plain');
                if (symbol) {
                    addElement(symbol);
                }
            });

            // In-molecule element controls
            currentMoleculeEl.addEventListener('click', (e) => {
                const btn = e.target.closest('.atom-control-btn');
                if (!btn) return;
                const { action, symbol } = btn.dataset;
                const element = elementsData.find(e => e.symbol === symbol);
                
                if (action === 'add') {
                    addElement(symbol);
                } else if (action === 'subtract') {
                    if (currentElements[symbol] > 1) {
                        currentElements[symbol]--;
                        currentMolarMass -= element.mass;
                    } else {
                        currentMolarMass -= element.mass * currentElements[symbol];
                        delete currentElements[symbol];
                    }
                    renderCurrentMolecule();
                } else if (action === 'delete') {
                    currentMolarMass -= element.mass * currentElements[symbol];
                    delete currentElements[symbol];
                    renderCurrentMolecule();
                }
            });
            
            // Event listener for difficulty change
            difficultySelect.addEventListener('change', () => {
                startGame();
            });

            // Message box button event listener
            messageBtn.addEventListener('click', hideMessage);

            // Initial setup
            renderElements();
            startGame();

            if (firebaseConfig.apiKey) {
                initAuth();
            } else {
                console.warn("Firebase config not available. High scores will not be saved.");
            }
        };
    </script>
</body>
</html>
