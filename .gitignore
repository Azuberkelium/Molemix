<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Molecule Mix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Copperplate Gothic', sans-serif;
        }
        .bg-gradient {
            background-image: linear-gradient(135deg, #1f2937 0%, #0d121c 100%);
        }
        .card {
            background-color: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
        }
        .btn-element {
            transition: all 0.2s ease-in-out;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-element:hover {
            transform: translateY(-2px) scale(1.05);
            background-color: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .btn-action {
            background-color: #3b82f6;
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        .btn-action:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
        }
        .btn-nicer {
            background-image: linear-gradient(45deg, #8b5cf6 0%, #6366f1 100%);
            transition: all 0.2s ease-in-out;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .btn-nicer:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        .btn-success {
            background-color: #22c55e;
        }
        .btn-success:hover {
            background-color: #16a34a;
        }
        .btn-danger {
            background-color: #ef4444;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .btn-lifeline {
            background-color: #f59e0b;
            transition: all 0.2s ease-in-out;
        }
        .btn-lifeline:hover {
            background-color: #d97706;
        }
        .message-box, #calculator-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85);
            border-radius: 12px;
            padding: 3rem 2rem;
            color: white;
            z-index: 100;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            width: 90%;
            max-width: 500px;
        }
        .message-box p {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }
        .pulse-green {
            animation: pulse-green 0.5s ease-in-out;
        }
        .pulse-red {
            animation: pulse-red 0.5s ease-in-out;
        }
        @keyframes pulse-green {
            0% { transform: scale(1); background-color: #22c55e; }
            50% { transform: scale(1.05); background-color: #16a34a; }
            100% { transform: scale(1); background-color: #22c55e; }
        }
        @keyframes pulse-red {
            0% { transform: scale(1); background-color: #ef4444; }
            50% { transform: scale(1.05); background-color: #dc2626; }
            100% { transform: scale(1); background-color: #ef4444; }
        }
        /* Molecule element styling */
        .molecule-atom {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 0.5rem;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .molecule-atom:hover {
            transform: translateY(-2px);
        }
        .calculator-btn {
            @apply flex items-center justify-center p-4 rounded-xl shadow-md transition-colors duration-200;
            background-color: rgba(255, 255, 255, 0.1);
        }
        .calculator-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .calculator-btn.op-btn {
            @apply bg-blue-500 text-white;
        }
        .calculator-btn.eq-btn {
            @apply col-span-2 bg-blue-600 text-white;
        }
        .calculator-btn.clear-btn {
            @apply bg-red-500 text-white;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">
    <div class="container mx-auto p-4 md:p-8 rounded-2xl shadow-2xl card flex flex-col items-center">
        <div class="w-full flex justify-between items-center mb-6">
            <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-600">Molecule Mix</h1>
            <button id="how-to-play-btn" class="btn-action text-white font-bold py-2 px-4 rounded-full shadow-lg">How to Play</button>
        </div>

        <div class="w-full flex justify-between items-center mb-4">
            <div class="flex items-center gap-2">
                <span class="text-gray-400">Score:</span>
                <span id="molecules-built" class="text-xl font-bold">0</span>
            </div>
            <div class="flex items-center gap-2">
                <label for="difficulty" class="text-gray-400">Difficulty:</label>
                <select id="difficulty" class="bg-gray-700 text-white rounded-md p-1 outline-none">
                    <option value="molars">Molars</option>
                    <option value="mass">Mass</option>
                    <option value="hard">Hard</option>
                </select>
            </div>
        </div>

        <div class="w-full grid md:grid-cols-2 gap-8 mb-8">
            <!-- Game Section -->
            <div class="card p-6 rounded-2xl">
                <h2 class="text-3xl font-bold mb-4 text-center">Build This Molecule</h2>
                <div class="flex flex-col items-center justify-center bg-gray-800 p-6 rounded-xl shadow-inner mb-4">
                    <h3 id="target-title" class="text-2xl font-semibold text-blue-300"></h3>
                    <p id="target-formula" class="text-5xl font-bold my-2"></p>
                    <p id="target-description" class="text-sm text-gray-400 text-center"></p>
                    <div id="starting-elements-display" class="mt-4 p-2 bg-gray-900 rounded-lg hidden"></div>
                </div>

                <div class="w-full flex justify-center mb-4">
                    <div id="how-it-works" class="text-sm text-center text-gray-400"></div>
                </div>

                <div class="flex justify-between items-center text-xl font-bold mb-4">
                    <span>Your Molecule</span>
                    <span class="text-sm text-gray-400" id="molar-mass-label">Molar Mass: <span id="molar-mass">0.00</span></span>
                </div>

                <div id="current-molecule-container" class="card p-4 rounded-xl mb-4 h-40 flex items-center justify-center">
                    <div id="current-molecule" class="w-full h-full flex items-center justify-center gap-4 flex-wrap">
                        <p class="text-gray-500">Click elements below to begin...</p>
                    </div>
                </div>

                <!-- Mass difficulty specific UI -->
                <div id="mass-mode-ui" class="hidden flex flex-col gap-2 mb-4">
                    <div class="flex items-center gap-2">
                        <label class="text-gray-400 text-sm w-1/2" for="mass-input">Total Molar Mass:</label>
                        <input id="mass-input" type="number" step="0.01" class="w-full bg-gray-800 text-white px-4 py-2 rounded-lg border border-gray-700 focus:outline-none focus:border-blue-500" readonly>
                    </div>
                    <p class="text-gray-400 text-sm">Enter the individual masses of the elements below.</p>
                    <div id="individual-mass-inputs" class="flex flex-col gap-2 mt-4"></div>
                </div>
                
                <div class="flex flex-col md:flex-row gap-4 mb-4">
                    <button id="check-btn" class="flex-1 btn-nicer text-white font-bold py-3 px-6 rounded-full shadow-lg">Check Formula</button>
                    <button id="next-btn" class="flex-1 btn-action text-white font-bold py-3 px-6 rounded-full shadow-lg hidden">Next Molecule</button>
                    <button id="calculator-btn" data-zubi-code="76" class="flex-1 btn-nicer text-white font-bold py-3 px-6 rounded-full shadow-lg">Calculator</button>
                </div>
                
                <div id="game-message" class="text-center font-semibold mt-2"></div>
            </div>

            <!-- Elements and Lifelines Section -->
            <div class="flex flex-col gap-8">
                <div class="card p-6 rounded-2xl flex-1">
                    <h2 class="text-2xl font-bold mb-4 text-center">Periodic Table</h2>
                    <div id="element-grid" class="grid grid-cols-4 md:grid-cols-5 gap-3"></div>
                </div>
                
                <div id="lifelines-section" class="card p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4 text-center">Lifelines</h2>
                    <div class="flex flex-col gap-2">
                        <button id="show-molar-mass-btn" class="btn-lifeline text-white font-bold py-2 px-4 rounded-full shadow-md"></button>
                        <button id="add-atom-btn" class="btn-lifeline text-white font-bold py-2 px-4 rounded-full shadow-md"></button>
                        <button id="swap-atom-btn" class="btn-lifeline text-white font-bold py-2 px-4 rounded-full shadow-md"></button>
                        <button id="hint-btn" class="btn-lifeline text-white font-bold py-2 px-4 rounded-full shadow-md"></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Message Box -->
        <div id="message-box" class="message-box hidden">
            <p id="message-text"></p>
            <button id="message-btn" class="w-full btn-action text-white font-bold py-2 px-4 rounded-full">Got it!</button>
        </div>

        <!-- Calculator Modal -->
        <div id="calculator-modal" class="hidden flex flex-col items-center">
            <h2 class="text-3xl font-bold mb-4">Calculator</h2>
            <div class="w-full bg-gray-800 p-4 rounded-lg shadow-inner mb-4 text-right text-3xl font-mono overflow-x-auto">
                <span id="calc-display">0</span>
            </div>
            <div class="grid grid-cols-4 gap-3 w-full">
                <button class="calculator-btn clear-btn col-span-3">C</button>
                <button class="calculator-btn op-btn">/</button>
                <button class="calculator-btn">7</button>
                <button class="calculator-btn">8</button>
                <button class="calculator-btn">9</button>
                <button class="calculator-btn op-btn">*</button>
                <button class="calculator-btn">4</button>
                <button class="calculator-btn">5</button>
                <button class="calculator-btn">6</button>
                <button class="calculator-btn op-btn">-</button>
                <button class="calculator-btn">1</button>
                <button class="calculator-btn">2</button>
                <button class="calculator-btn">3</button>
                <button class="calculator-btn op-btn">+</button>
                <button class="calculator-btn">0</button>
                <button class="calculator-btn">.</button>
                <button class="calculator-btn eq-btn" onclick="calculate()">=</button>
            </div>
            <button id="close-calc-btn" class="w-full btn-action text-white font-bold py-2 px-4 rounded-full mt-4">Close</button>
        </div>
    </div>
    
    <script>
        window.onload = function() {
            const elementsData = [
                { symbol: 'H', name: 'Hydrogen', mass: 1.01 },
                { symbol: 'O', name: 'Oxygen', mass: 16.00 },
                { symbol: 'C', name: 'Carbon', mass: 12.01 },
                { symbol: 'N', name: 'Nitrogen', mass: 14.01 },
                { symbol: 'Cl', name: 'Chlorine', mass: 35.45 },
                { symbol: 'Na', name: 'Sodium', mass: 22.99 },
                { symbol: 'S', name: 'Sulfur', mass: 32.07 },
                { symbol: 'P', name: 'Phosphorus', mass: 30.97 },
                { symbol: 'Mg', name: 'Magnesium', mass: 24.31 },
                { symbol: 'K', name: 'Potassium', mass: 39.10 },
                { symbol: 'Fe', name: 'Iron', mass: 55.85 },
                { symbol: 'Ca', name: 'Calcium', mass: 40.08 },
                { symbol: 'Al', name: 'Aluminum', mass: 26.98 },
                { symbol: 'Si', name: 'Silicon', mass: 28.09 },
                { symbol: 'F', name: 'Fluorine', mass: 19.00 },
                { symbol: 'Br', name: 'Bromine', mass: 79.90 },
                { symbol: 'He', name: 'Helium', mass: 4.00 },
                { symbol: 'Li', name: 'Lithium', mass: 6.94 },
                { symbol: 'Ne', name: 'Neon', mass: 20.18 },
                { symbol: 'Ar', name: 'Argon', mass: 39.95 },
                { symbol: 'Cu', name: 'Copper', mass: 63.55 },
                { symbol: 'Zn', name: 'Zinc', mass: 65.38 },
                { symbol: 'Ag', name: 'Silver', mass: 107.87 },
                { symbol: 'Pb', name: 'Lead', mass: 207.2 },
            ];

            const moleculesData = {
                molars: [
                    { name: 'Water', formula: 'H₂O', atoms: { 'H': 2, 'O': 1 }, description: 'The most abundant molecule on Earth, essential for life.' },
                    { name: 'Carbon Dioxide', formula: 'CO₂', atoms: { 'C': 1, 'O': 2 }, description: 'A greenhouse gas used by plants for photosynthesis.' },
                    { name: 'Methane', formula: 'CH₄', atoms: { 'C': 1, 'H': 4 }, description: 'The primary component of natural gas.' },
                    { name: 'Ammonia', formula: 'NH₃', atoms: { 'N': 1, 'H': 3 }, description: 'A common cleaning agent with a distinctive, sharp smell.' },
                    { name: 'Hydrochloric Acid', formula: 'HCl', atoms: { 'H': 1, 'Cl': 1 }, description: 'A strong acid found in stomach fluids to aid digestion.' },
                    { name: 'Hydrogen Peroxide', formula: 'H₂O₂', atoms: { 'H': 2, 'O': 2 }, description: 'Commonly used as a mild antiseptic for minor cuts.' },
                    { name: 'Sodium Hydroxide', formula: 'NaOH', atoms: { 'Na': 1, 'O': 1, 'H': 1 }, description: 'Commonly known as lye, a strong base.' },
                    { name: 'Sulfur Dioxide', formula: 'SO₂', atoms: { 'S': 1, 'O': 2 }, description: 'A gas released from volcanoes and industrial processes.' },
                    { name: 'Salt (LiCl)', formula: 'LiCl', atoms: { 'Li': 1, 'Cl': 1 }, description: 'Lithium Chloride, a salt with a bitter taste.' },
                    { name: 'Propene', formula: 'C₃H₆', atoms: { 'C': 3, 'H': 6 }, description: 'An unsaturated hydrocarbon.' },
                    { name: 'Ethylene', formula: 'C₂H₄', atoms: { 'C': 2, 'H': 4 }, description: 'A simple hydrocarbon used in plastics.' },
                    { name: 'Nitrous Oxide', formula: 'N₂O', atoms: { 'N': 2, 'O': 1 }, description: 'Commonly known as laughing gas.' },
                ],
                mass: [
                    { name: 'Sodium Chloride', formula: 'NaCl', atoms: { 'Na': 1, 'Cl': 1 }, description: 'Common table salt, an ionic compound.' },
                    { name: 'Sulfuric Acid', formula: 'H₂SO₄', atoms: { 'H': 2, 'S': 1, 'O': 4 }, description: 'A highly corrosive acid used in industrial applications.' },
                    { name: 'Baking Soda', formula: 'NaHCO₃', atoms: { 'Na': 1, 'H': 1, 'C': 1, 'O': 3 }, description: 'A leavening agent used in baking to make dough rise.' },
                    { name: 'Glucose', formula: 'C₆H₁₂O₆', atoms: { 'C': 6, 'H': 12, 'O': 6 }, description: 'A simple sugar that is a key source of energy for living organisms.' },
                    { name: 'Ethane', formula: 'C₂H₆', atoms: { 'C': 2, 'H': 6 }, description: 'The second simplest alkane hydrocarbon, found in natural gas.' },
                    { name: 'Urea', formula: 'CH₄N₂O', atoms: { 'C': 1, 'H': 4, 'N': 2, 'O': 1 }, description: 'Used in fertilizers, and produced by the body to excrete nitrogen.' },
                    { name: 'Propane', formula: 'C₃H₈', atoms: { 'C': 3, 'H': 8 }, description: 'A common fuel for stoves, heating, and vehicles.' },
                    { name: 'Magnesium Hydroxide', formula: 'Mg(OH)₂', atoms: { 'Mg': 1, 'O': 2, 'H': 2 }, description: 'Known as milk of magnesia, a common antacid.' },
                    { name: 'Phosphoric Acid', formula: 'H₃PO₄', atoms: { 'H': 3, 'P': 1, 'O': 4 }, description: 'Used in sodas and fertilizers.' },
                    { name: 'Potassium Nitrate', formula: 'KNO₃', atoms: { 'K': 1, 'N': 1, 'O': 3 }, description: 'A key component of gunpowder and fertilizers.' },
                    { name: 'Calcium Carbonate', formula: 'CaCO₃', atoms: { 'Ca': 1, 'C': 1, 'O': 3 }, description: 'The main component of shells, limestone, and chalk.' },
                    { name: 'Ethanol', formula: 'C₂H₆O', atoms: { 'C': 2, 'H': 6, 'O': 1 }, description: 'Commonly known as alcohol, used in beverages and fuel.' },
                    { name: 'Calcium Chloride', formula: 'CaCl₂', atoms: { 'Ca': 1, 'Cl': 2 }, description: 'A common salt used to de-ice roads.' },
                    { name: 'Zinc Sulfate', formula: 'ZnSO₄', atoms: { 'Zn': 1, 'S': 1, 'O': 4 }, description: 'Used as a dietary supplement and in medicine.' },
                ],
                hard: [
                    { name: 'Water', formula: 'H₂O', targetAtoms: { 'H': 2, 'O': 1 }, moles: 2, startingAtoms: { 'H': 5, 'O': 3 }, description: 'Build two moles of water. What elements will be left over?' },
                    { name: 'Carbon Dioxide', formula: 'CO₂', targetAtoms: { 'C': 1, 'O': 2 }, moles: 3, startingAtoms: { 'C': 4, 'O': 7 }, description: 'Build three moles of Carbon Dioxide. Be careful with your counts!' },
                    { name: 'Sucrose', formula: 'C₁₂H₂₂O₁₁', targetAtoms: { 'C': 12, 'H': 22, 'O': 11 }, moles: 1, startingAtoms: { 'C': 15, 'H': 25, 'O': 12 }, description: 'Build one molecule of table sugar from the given atoms. You will have leftovers.' },
                    { name: 'Ethanol', formula: 'C₂H₆O', targetAtoms: { 'C': 2, 'H': 6, 'O': 1 }, moles: 2, startingAtoms: { 'C': 5, 'H': 15, 'O': 3 }, description: 'Build two moles of ethanol. You must use the correct quantity of each starting element.' },
                    { name: 'Aluminum Sulfate', formula: 'Al₂(SO₄)₃', targetAtoms: { 'Al': 2, 'S': 3, 'O': 12 }, moles: 1, startingAtoms: { 'Al': 3, 'S': 4, 'O': 15 }, description: 'Make this industrial chemical. This is a tough one!' },
                    { name: 'Ammonium Nitrate', formula: 'NH₄NO₃', targetAtoms: { 'N': 2, 'H': 4, 'O': 3 }, moles: 1, startingAtoms: { 'N': 4, 'H': 6, 'O': 5 }, description: 'This is a key component in fertilizer and explosives. Be precise.' },
                    { name: 'Ferric Oxide (Rust)', formula: 'Fe₂O₃', targetAtoms: { 'Fe': 2, 'O': 3 }, moles: 2, startingAtoms: { 'Fe': 5, 'O': 7 }, description: 'Build two moles of rust from the starting atoms.' },
                    { name: 'Magnesium Nitrate', formula: 'Mg(NO₃)₂', targetAtoms: { 'Mg': 1, 'N': 2, 'O': 6 }, moles: 1, startingAtoms: { 'Mg': 2, 'N': 3, 'O': 8 }, description: 'This compound is used in agriculture and pyrotechnics.' },
                    { name: 'Boric Acid', formula: 'H₃BO₃', targetAtoms: { 'H': 3, 'B': 1, 'O': 3 }, moles: 2, startingAtoms: { 'H': 7, 'B': 3, 'O': 7 }, description: 'Used as an antiseptic and insecticide.' },
                    { name: 'Silver Nitrate', formula: 'AgNO₃', targetAtoms: { 'Ag': 1, 'N': 1, 'O': 3 }, moles: 1, startingAtoms: { 'Ag': 2, 'N': 2, 'O': 5 }, description: 'Used in photography and as an antiseptic. Use all atoms provided.' },
                    { name: 'Lead(II) Chloride', formula: 'PbCl₂', targetAtoms: { 'Pb': 1, 'Cl': 2 }, moles: 3, startingAtoms: { 'Pb': 4, 'Cl': 7 }, description: 'A solid that forms from mixing lead and chloride solutions. You will have some atoms leftover.' },
                    { name: 'Potassium Ferricyanide', formula: 'K₃Fe(CN)₆', targetAtoms: { 'K': 3, 'Fe': 1, 'C': 6, 'N': 6 }, moles: 1, startingAtoms: { 'K': 5, 'Fe': 2, 'C': 8, 'N': 8 }, description: 'A bright red salt often used in photography and blueprints.' },
                ]
            };

            // DOM elements
            const difficultySelect = document.getElementById('difficulty');
            const moleculesBuiltEl = document.getElementById('molecules-built');
            const targetTitleEl = document.getElementById('target-title');
            const targetFormulaEl = document.getElementById('target-formula');
            const targetDescriptionEl = document.getElementById('target-description');
            const howItWorksEl = document.getElementById('how-it-works');
            const currentMoleculeContainerEl = document.getElementById('current-molecule-container');
            const currentMoleculeEl = document.getElementById('current-molecule');
            const molarMassEl = document.getElementById('molar-mass');
            const molarMassLabelEl = document.getElementById('molar-mass-label');
            const elementGrid = document.getElementById('element-grid');
            const checkBtn = document.getElementById('check-btn');
            const nextBtn = document.getElementById('next-btn');
            const gameMessageEl = document.getElementById('game-message');
            const showMolarMassBtn = document.getElementById('show-molar-mass-btn');
            const addAtomBtn = document.getElementById('add-atom-btn');
            const swapAtomBtn = document.getElementById('swap-atom-btn');
            const hintBtn = document.getElementById('hint-btn');
            const startingElementsEl = document.getElementById('starting-elements-display');
            const howToPlayBtn = document.getElementById('how-to-play-btn');
            const massInput = document.getElementById('mass-input');
            const massModeUI = document.getElementById('mass-mode-ui');
            const individualMassInputs = document.getElementById('individual-mass-inputs');
            const calculatorBtn = document.getElementById('calculator-btn');

            // Game state
            let moleculesBuilt = 0;
            let currentLevel = 'molars';
            let levelMolecules = [];
            let currentTarget = null;
            let currentElements = {};
            let currentMolarMass = 0;
            let lifelines = {
                showMass: 1,
                addAtom: 1,
                swapAtom: 1,
                hint: 1
            };

            // Message box
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            const messageBtn = document.getElementById('message-btn');

            // Calculator state and DOM
            const calculatorModal = document.getElementById('calculator-modal');
            const calcDisplay = document.getElementById('calc-display');
            const calcButtons = calculatorModal.querySelectorAll('button');
            const closeCalcBtn = document.getElementById('close-calc-btn');
            let calcInput = '0';
            let calcOperator = null;
            let calcResult = null;
            let waitingForNewInput = false;

            // Helper function for showing messages
            function showMessage(text) {
                messageText.innerHTML = text;
                messageBox.classList.remove('hidden');
            }

            // Helper function to hide the message box
            function hideMessage() {
                messageBox.classList.add('hidden');
            }

            // Function to calculate the molar mass of a molecule
            function calculateMolarMass(atoms) {
                let totalMass = 0;
                for (const symbol in atoms) {
                    const element = elementsData.find(e => e.symbol === symbol);
                    if (element) {
                        totalMass += element.mass * atoms[symbol];
                    }
                }
                return totalMass;
            }

            // Function to render elements on the screen
            function renderElements() {
                elementGrid.innerHTML = '';
                elementsData.forEach(element => {
                    const btn = document.createElement('div');
                    btn.className = 'btn-element flex flex-col items-center justify-center p-4 rounded-xl shadow-md cursor-pointer transition-colors duration-200 hover:bg-white/20';
                    btn.dataset.symbol = element.symbol;
                    btn.innerHTML = `
                        <span class="text-4xl font-bold text-blue-300">${element.symbol}</span>
                        <span class="text-xs text-gray-400 font-mono">${element.mass.toFixed(2)} g/mol</span>
                    `;
                    btn.addEventListener('click', () => {
                        addElement(element.symbol);
                    });
                    elementGrid.appendChild(btn);
                });
            }

            // Function to update total molar mass from individual inputs
            function updateTotalMolarMass() {
                let total = 0;
                const massInputs = document.querySelectorAll('#individual-mass-inputs input');
                massInputs.forEach(input => {
                    if (!isNaN(parseFloat(input.value))) {
                        total += parseFloat(input.value);
                    }
                });
                massInput.value = total.toFixed(2);
            }
            
            // Function to start or restart the game
            function startGame() {
                moleculesBuilt = 0;
                moleculesBuiltEl.textContent = moleculesBuilt;
                currentLevel = difficultySelect.value;
                levelMolecules = [...moleculesData[currentLevel]];
                lifelines = { showMass: 1, addAtom: 1, swapAtom: 1, hint: 1 };
                updateLifelinesUI();
                nextMolecule();

                // Show/hide mass mode UI and molar mass label
                if (currentLevel === 'mass') {
                    massModeUI.classList.remove('hidden');
                    molarMassLabelEl.classList.add('hidden');
                } else {
                    massModeUI.classList.add('hidden');
                    molarMassLabelEl.classList.remove('hidden');
                }

                // Show/hide starting elements display
                if (currentLevel === 'hard') {
                     startingElementsEl.classList.remove('hidden');
                } else {
                    startingElementsEl.classList.add('hidden');
                }

                // Update 'how it works' message
                let messageText = '';
                if (currentLevel === 'molars') {
                    messageText = 'Simply match the formula. Molar mass is calculated for you.';
                } else if (currentLevel === 'mass') {
                    messageText = 'Enter the individual masses of the elements to win this level. The total mass will auto-update.';
                } else if (currentLevel === 'hard') {
                    messageText = 'Use the atoms provided to build the target molecule. You may have leftovers.';
                }
                howItWorksEl.textContent = messageText;
            }

            // Function to move to the next molecule
            function nextMolecule() {
                if (levelMolecules.length === 0) {
                    showMessage('Congratulations! You completed all the molecules for this difficulty level. Your score has been saved!');
                    startGame(); // Restart the level
                    return;
                }
                const randomIndex = Math.floor(Math.random() * levelMolecules.length);
                currentTarget = levelMolecules.splice(randomIndex, 1)[0];
                updateGameUI();
                resetGame();
                checkBtn.classList.remove('hidden');
                nextBtn.classList.add('hidden');
            }

            // Function to update the UI based on the current target molecule
            function updateGameUI() {
                if (currentTarget.moles > 1) {
                    targetTitleEl.textContent = `${currentTarget.moles} moles of ${currentTarget.name}`;
                } else {
                    targetTitleEl.textContent = currentTarget.name;
                }
                let formulaHtml = currentTarget.formula.replace(/(\d+)/g, '<sub>$1</sub>');
                targetFormulaEl.innerHTML = formulaHtml;
                targetDescriptionEl.textContent = currentTarget.description;
                
                // Show starting elements for hard mode
                if (currentLevel === 'hard') {
                    let startingHtml = '';
                    for (const [symbol, count] of Object.entries(currentTarget.startingAtoms)) {
                        startingHtml += `<div class="bg-gray-700 text-white rounded-lg px-2 py-1">${symbol}<sub>${count}</sub></div>`;
                    }
                    startingElementsEl.innerHTML = `<p class="text-xs text-gray-400">Starting Elements:</p> <div class="flex gap-2 mt-1">${startingHtml}</div>`;
                }
            }

            // Function to add an element to the current molecule
            function addElement(symbol) {
                currentElements[symbol] = (currentElements[symbol] || 0) + 1;
                const element = elementsData.find(e => e.symbol === symbol);
                currentMolarMass += element.mass;
                renderCurrentMolecule();
                if (currentLevel === 'mass') {
                     updateTotalMolarMass();
                }
            }

            // Function to render the selected elements in the UI
            function renderCurrentMolecule() {
                currentMoleculeEl.innerHTML = '';
                individualMassInputs.innerHTML = '';
                
                if (Object.keys(currentElements).length === 0) {
                    currentMoleculeEl.innerHTML = '<p class="text-gray-500">Click elements below to begin...</p>';
                } else {
                    for (const symbol in currentElements) {
                        const count = currentElements[symbol];
                        const elementEl = document.createElement('div');
                        elementEl.className = 'molecule-atom flex flex-col items-center justify-center p-4 rounded-xl shadow-md cursor-pointer';
                        elementEl.dataset.symbol = symbol;
                        elementEl.innerHTML = `
                            <span class="text-3xl font-bold text-blue-300">${symbol}</span>
                            <span class="text-sm bg-gray-600 px-1 rounded absolute bottom-0 right-0">${count}</span>
                        `;
                        elementEl.addEventListener('click', () => {
                            removeElement(symbol);
                        });
                        currentMoleculeEl.appendChild(elementEl);

                        // Render individual mass inputs for Mass difficulty
                        if (currentLevel === 'mass') {
                            const inputContainer = document.createElement('div');
                            inputContainer.className = 'flex items-center gap-2';
                            const element = elementsData.find(e => e.symbol === symbol);
                            const mass = element.mass * count;
                            const inputField = document.createElement('input');
                            inputField.type = 'number';
                            inputField.step = '0.01';
                            inputField.className = 'w-full bg-gray-800 text-white px-2 py-1 rounded-lg border border-gray-700 focus:outline-none focus:border-blue-500';
                            inputField.placeholder = `${symbol} mass`;
                            inputField.dataset.symbol = symbol;
                            inputField.dataset.count = count;
                            inputField.addEventListener('input', updateTotalMolarMass);
                            
                            inputContainer.innerHTML = `
                                <label class="text-gray-400 text-sm w-1/2">${symbol} (${count} atom${count > 1 ? 's' : ''}):</label>
                            `;
                            inputContainer.appendChild(inputField);
                            individualMassInputs.appendChild(inputContainer);
                        }
                    }
                }
                molarMassEl.textContent = currentMolarMass.toFixed(2);
            }
            
            // Function to remove an element from the current molecule
            function removeElement(symbol) {
                const element = elementsData.find(e => e.symbol === symbol);
                if (!element) return;
                
                if (currentElements[symbol] && currentElements[symbol] > 1) {
                    currentElements[symbol]--;
                    currentMolarMass -= element.mass;
                } else if (currentElements[symbol] && currentElements[symbol] === 1) {
                    currentMolarMass -= element.mass;
                    delete currentElements[symbol];
                }
                renderCurrentMolecule();
                if (currentLevel === 'mass') {
                    updateTotalMolarMass();
                }
            }

            // Function to reset the game state
            function resetGame() {
                currentElements = {};
                currentMolarMass = 0;
                gameMessageEl.innerHTML = '';
                renderCurrentMolecule();
                massInput.value = '0.00';
            }

            // Function to update lifeline UI
            function updateLifelinesUI() {
                showMolarMassBtn.textContent = `Show Molar Mass (${lifelines.showMass})`;
                addAtomBtn.textContent = `Auto-Add Atom (${lifelines.addAtom})`;
                swapAtomBtn.textContent = `Swap Atom (${lifelines.swapAtom})`;
                hintBtn.textContent = `Hint (${lifelines.hint})`;

                showMolarMassBtn.disabled = lifelines.showMass <= 0;
                addAtomBtn.disabled = lifelines.addAtom <= 0;
                swapAtomBtn.disabled = lifelines.swapAtom <= 0;
                hintBtn.disabled = lifelines.hint <= 0;
            }

            // Event listener for the "Check Formula" button
            checkBtn.addEventListener('click', () => {
                const targetAtoms = currentTarget.targetAtoms || currentTarget.atoms;
                const totalTargetAtoms = {};
                for (const [symbol, count] of Object.entries(targetAtoms)) {
                    totalTargetAtoms[symbol] = count * (currentTarget.moles || 1);
                }

                // Check if element ratios and counts match
                const currentRatio = Object.keys(currentElements).map(key => ({ symbol: key, count: currentElements[key] })).sort((a, b) => a.symbol.localeCompare(b.symbol));
                const targetRatio = Object.keys(totalTargetAtoms).map(key => ({ symbol: key, count: totalTargetAtoms[key] })).sort((a, b) => a.symbol.localeCompare(b.symbol));

                let isRatioMatch = false;
                if (currentRatio.length === targetRatio.length) {
                    isRatioMatch = currentRatio.every((val, index) => {
                        return val.symbol === targetRatio[index].symbol && val.count === targetRatio[index].count;
                    });
                }
                
                const singleMoleMass = calculateMolarMass(targetAtoms);
                const totalTargetMass = singleMoleMass * (currentTarget.moles || 1);

                let success = false;
                let message = '';

                if (currentLevel === 'mass') {
                    // Check if individual masses sum up to the correct total
                    const userTotalMass = parseFloat(massInput.value);
                    const massMatch = Math.abs(userTotalMass - totalTargetMass) < 0.02;
                    
                    if (isRatioMatch && massMatch) {
                        success = true;
                        message = `<span class="text-green-400">Correct! Your formula and all masses are right.</span>`;
                    } else if (!isRatioMatch) {
                        message = `<span class="text-red-400">Incorrect. Your atom ratios are wrong. Try again!</span>`;
                    } else if (!massMatch) {
                        message = `<span class="text-red-400">Incorrect. The total mass you entered is wrong.</span>`;
                    }
                } else if (currentLevel === 'hard') {
                    const startingAtoms = currentTarget.startingAtoms;
                    let isCountValid = true;
                    for (const symbol in currentElements) {
                        if ((startingAtoms[symbol] || 0) < currentElements[symbol]) {
                            isCountValid = false;
                            break;
                        }
                    }
                    if (isRatioMatch && isCountValid) {
                        success = true;
                        message = `<span class="text-green-400">Correct!</span><br/>`;
                        let leftover = {};
                        for (const symbol in startingAtoms) {
                            const usedCount = currentElements[symbol] || 0;
                            leftover[symbol] = startingAtoms[symbol] - usedCount;
                        }
                        let leftoverText = "Leftover atoms:";
                        for (const [symbol, count] of Object.entries(leftover)) {
                            if (count > 0) {
                                leftoverText += ` ${symbol}<sub>${count}</sub>`;
                            }
                        }
                        message += `<span class="text-white">${leftoverText}</span>`;
                    } else {
                        message = `<span class="text-red-400">Incorrect. Check your atom counts and ratios.</span>`;
                    }
                } else { // Molars level
                    if (isRatioMatch) {
                        success = true;
                        message = `<span class="text-green-400">Correct! You formed ${currentTarget.moles || 1} mole(s) of ${currentTarget.name}.</span>`;
                    } else {
                        message = `<span class="text-red-400">Incorrect formula. The total molar mass or element ratios are wrong. Try again!</span>`;
                    }
                }

                if (success) {
                    moleculesBuilt++;
                    moleculesBuiltEl.textContent = moleculesBuilt;
                    checkBtn.classList.add('btn-success');
                    checkBtn.classList.add('pulse-green');
                    checkBtn.classList.add('hidden');
                    nextBtn.classList.remove('hidden');
                    lifelines.showMass++;
                    lifelines.addAtom++;
                    lifelines.swapAtom++;
                    lifelines.hint++;
                    updateLifelinesUI();
                } else {
                    checkBtn.classList.add('btn-danger');
                    checkBtn.classList.add('pulse-red');
                    setTimeout(() => checkBtn.classList.remove('btn-danger', 'pulse-red'), 1000);
                }
                gameMessageEl.innerHTML = message;
            });

            // Event listener for the "Next Molecule" button
            nextBtn.addEventListener('click', () => {
                checkBtn.classList.remove('btn-success', 'pulse-green');
                nextMolecule();
            });

            // Event listener for the "Calculator" button
            calculatorBtn.addEventListener('click', () => {
                calculatorModal.classList.remove('hidden');
            });

            // Event listener to close the calculator modal
            closeCalcBtn.addEventListener('click', () => {
                calculatorModal.classList.add('hidden');
            });

            // Event listeners for the calculator logic
            calcButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const value = button.textContent;
                    if (!isNaN(parseInt(value)) || value === '.') {
                        if (calcInput === '0' || waitingForNewInput) {
                            calcInput = (value === '.') ? '0.' : value;
                            waitingForNewInput = false;
                        } else {
                            calcInput += value;
                        }
                        calcDisplay.textContent = calcInput;
                    } else if (value === 'C') {
                        calcInput = '0';
                        calcOperator = null;
                        calcResult = null;
                        waitingForNewInput = false;
                        calcDisplay.textContent = calcInput;
                    } else if (value !== '=') {
                        if (calcResult !== null && calcOperator) {
                            calcResult = eval(`${calcResult} ${calcOperator} ${parseFloat(calcInput)}`);
                        } else {
                            calcResult = parseFloat(calcInput);
                        }
                        calcOperator = value;
                        waitingForNewInput = true;
                        calcDisplay.textContent = calcResult;
                    }
                });
            });

            function calculate() {
                if (calcOperator && calcResult !== null) {
                    calcResult = eval(`${calcResult} ${calcOperator} ${parseFloat(calcInput)}`);
                    calcInput = calcResult;
                    calcOperator = null;
                    waitingForNewInput = true;
                    calcDisplay.textContent = calcResult;
                }
            }
            
            // Event listener for the "How to Play" button
            howToPlayBtn.addEventListener('click', () => {
                const howToPlayContent = `
                    <h3 class="text-2xl font-bold mb-4">How to Play</h3>
                    <p class="mb-2">Your goal is to build the target molecule shown at the top of the screen. You must get the **composition and molar ratio** correct!</p>
                    <ul class="list-disc list-inside space-y-2 text-left mb-4">
                        <li>**Add Atoms**: Click on an element in the **Periodic Table** to add one molar of that element to your molecule mix.</li>
                        <li>**Remove Atoms**: Click on an element in your **Your Molecule** mix to remove one molar of that element.</li>
                        <li>**Molars Difficulty**: On this level, the game will calculate the total molar mass for you, and you just need to match the atoms.</li>
                        <li>**Mass Difficulty**: On this level, you must manually calculate the total molar mass and enter it in the input field before checking your answer. You can use the **Calculator** button for help!</li>
                        <li>**Hard Difficulty**: Use the starting atoms provided to build the target molecule. You may have leftovers.</li>
                        <li>**Game Limitations**: This game is a simplified model. It focuses on the number and type of atoms, not their 3D structure or chemical bonds.</li>
                    </ul>
                    <h3 class="text-2xl font-bold mb-4">Lifelines</h3>
                    <p class="mb-2">Lifelines are earned by correctly building molecules. Use them when you're stuck!</p>
                    <ul class="list-disc list-inside space-y-2 text-left">
                        <li>**Show Molar Mass**: Reveals the total molar mass of the target molecule.</li>
                        <li>**Auto-Add Atom**: Adds one of the missing atoms to your mix.</li>
                        <li>**Swap Atom**: Swaps an incorrect or extra atom in your mix for a correct one.</li>
                        <li>**Hint**: Provides a general hint about the target molecule.</li>
                    </ul>
                `;
                showMessage(howToPlayContent);
            });

            // Event listeners for Lifelines
            showMolarMassBtn.addEventListener('click', () => {
                if (lifelines.showMass > 0) {
                    const targetAtoms = currentTarget.targetAtoms || currentTarget.atoms;
                    const singleMoleMass = calculateMolarMass(targetAtoms);
                    const totalTargetMass = singleMoleMass * (currentTarget.moles || 1);
                    showMessage(`The target molar mass is **${totalTargetMass.toFixed(2)}** g/mol.`);
                    lifelines.showMass--;
                    updateLifelinesUI();
                }
            });

            addAtomBtn.addEventListener('click', () => {
                if (lifelines.addAtom > 0) {
                    const targetAtoms = currentTarget.targetAtoms || currentTarget.atoms;
                    const totalTargetAtoms = {};
                    for (const [symbol, count] of Object.entries(targetAtoms)) {
                        totalTargetAtoms[symbol] = count * (currentTarget.moles || 1);
                    }
                    const missingSymbols = Object.keys(totalTargetAtoms).filter(symbol => (currentElements[symbol] || 0) < totalTargetAtoms[symbol]);
                    if (missingSymbols.length > 0) {
                        const randomSymbol = missingSymbols[Math.floor(Math.random() * missingSymbols.length)];
                        addElement(randomSymbol);
                        showMessage(`I've added one **${randomSymbol}** for you!`);
                        lifelines.addAtom--;
                        updateLifelinesUI();
                    } else {
                        showMessage("You've already added all the required atoms!");
                    }
                }
            });
            
            swapAtomBtn.addEventListener('click', () => {
                if (lifelines.swapAtom > 0) {
                    const incorrectSymbols = Object.keys(currentElements).filter(symbol => {
                        const targetAtoms = currentTarget.targetAtoms || currentTarget.atoms;
                        const totalTargetAtoms = {};
                        for (const [targetSymbol, count] of Object.entries(targetAtoms)) {
                            totalTargetMass[targetSymbol] = count * (currentTarget.moles || 1);
                        }
                        return !totalTargetAtoms[symbol] || currentElements[symbol] > totalTargetAtoms[symbol];
                    });

                    if (incorrectSymbols.length > 0) {
                        const symbolToSwap = incorrectSymbols[0];
                        
                        // Find a correct atom that is needed and is not in the current molecule or has less than the required amount
                        const targetAtoms = currentTarget.targetAtoms || currentTarget.atoms;
                        const totalTargetAtoms = {};
                        for (const [targetSymbol, count] of Object.entries(targetAtoms)) {
                            totalTargetMass[targetSymbol] = count * (currentTarget.moles || 1);
                        }
                        const missingSymbols = Object.keys(totalTargetAtoms).filter(symbol => (currentElements[symbol] || 0) < totalTargetAtoms[symbol]);
                        
                        if (missingSymbols.length > 0) {
                            const symbolToAdd = missingSymbols[0];
                            
                            // Subtract the incorrect element
                            currentElements[symbolToSwap]--;
                            if (currentElements[symbolToSwap] === 0) {
                                delete currentElements[symbolToSwap];
                            }
                            // Add the correct element
                            addElement(symbolToAdd);

                            showMessage(`Swapped one **${symbolToSwap}** for one **${symbolToAdd}**!`);
                            lifelines.swapAtom--;
                            updateLifelinesUI();
                        } else {
                            showMessage("No incorrect or extra atoms to swap!");
                        }
                    } else {
                        showMessage("No incorrect or extra atoms to swap!");
                    }
                }
            });

            hintBtn.addEventListener('click', () => {
                if (lifelines.hint > 0) {
                    const hintText = currentTarget.description;
                    showMessage(`Hint: ${hintText}`);
                    lifelines.hint--;
                    updateLifelinesUI();
                }
            });
            
            // Event listener for difficulty change
            difficultySelect.addEventListener('change', () => {
                startGame();
            });

            // Message box button event listener
            messageBtn.addEventListener('click', hideMessage);

            // Initial setup
            renderElements();
            startGame();
        };
    </script>
</body>
</html>
